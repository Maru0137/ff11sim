<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF11 Status Simulator</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a2e;
            color: #eee;
        }
        h1 {
            text-align: center;
            color: #f0c040;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 0;
        }
        .tab-btn {
            padding: 10px 20px;
            background: #0f0f23;
            color: #aaa;
            border: 1px solid #444;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
        }
        .tab-btn.active {
            background: #16213e;
            color: #f0c040;
            border-color: #f0c040;
        }
        .tab-content {
            display: none;
            background: #16213e;
            padding: 20px;
            border-radius: 0 10px 10px 10px;
            border: 1px solid #444;
        }
        .tab-content.active {
            display: block;
        }
        /* Common */
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .input-section, .result-section {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h2 {
            margin-top: 0;
            color: #f0c040;
            border-bottom: 2px solid #f0c040;
            padding-bottom: 10px;
        }
        h3 {
            color: #f0c040;
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
        }
        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #0f0f23;
            color: #eee;
            font-size: 14px;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #f0c040;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #0f0f23;
            border-radius: 5px;
        }
        .stat-name {
            color: #aaa;
        }
        .stat-value {
            font-weight: bold;
            color: #4fc3f7;
        }
        .stat-value.hp { color: #4caf50; }
        .stat-value.mp { color: #2196f3; }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .support-section {
            padding: 10px;
            background: #0f0f23;
            border-radius: 5px;
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
        .merit-section {
            margin-top: 20px;
            padding: 15px;
            background: #0f0f23;
            border-radius: 5px;
        }
        .merit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .merit-item {
            display: flex;
            flex-direction: column;
        }
        .merit-item label {
            font-size: 12px;
            margin-bottom: 3px;
        }
        .merit-item input {
            width: 100%;
            padding: 5px;
            font-size: 12px;
        }
        /* Character registration */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: #fff;
        }
        .btn-primary {
            background: #2196f3;
        }
        .btn-primary:hover {
            background: #1976d2;
        }
        .btn-danger {
            background: #f44336;
        }
        .btn-danger:hover {
            background: #d32f2f;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        .job-level-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .job-level-table th,
        .job-level-table td {
            padding: 4px 8px;
            text-align: center;
            border-bottom: 1px solid #333;
        }
        .job-level-table th {
            color: #f0c040;
            font-size: 12px;
        }
        .job-level-table td {
            font-size: 13px;
        }
        .job-level-table input {
            width: 60px;
            padding: 4px;
            font-size: 12px;
            text-align: center;
        }
        .job-level-table .job-name {
            color: #aaa;
            text-align: left;
            font-weight: bold;
        }
        .char-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .char-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #0f0f23;
            border-radius: 5px;
            margin-bottom: 4px;
            cursor: pointer;
        }
        .char-list li:hover {
            background: #1a1a3e;
        }
        .char-list li.selected {
            border: 1px solid #f0c040;
        }
        .char-list .char-info {
            color: #eee;
        }
        .char-list .char-race {
            color: #aaa;
            font-size: 12px;
            margin-left: 8px;
        }
        .char-list .char-actions {
            display: flex;
            gap: 4px;
        }
        .char-list .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }
        .empty-msg {
            color: #666;
            text-align: center;
            padding: 20px;
        }
        .equip-group-header {
            color: #f0c040;
            font-weight: bold;
            font-size: 13px;
            padding: 6px 12px 2px !important;
            background: none !important;
            cursor: default !important;
        }
        .equip-group-header:hover {
            background: none !important;
        }
        /* Equipment Set */
        .equip-slot-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .equip-slot-label {
            width: 70px;
            flex-shrink: 0;
            font-size: 12px;
            color: #aaa;
            text-align: right;
        }
        .equip-slot-input-wrapper {
            position: relative;
            flex: 1;
        }
        .equip-slot-search {
            width: 100%;
            padding: 5px 8px;
            font-size: 12px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #0f0f23;
            color: #eee;
        }
        .equip-slot-search:focus {
            outline: none;
            border-color: #f0c040;
        }
        .equip-slot-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: #0f0f23;
            border: 1px solid #f0c040;
            border-radius: 0 0 4px 4px;
            z-index: 100;
        }
        .equip-slot-dropdown-item {
            padding: 6px 8px;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 1px solid #222;
        }
        .equip-slot-dropdown-item:hover {
            background: #1a1a3e;
        }
        .equip-slot-selected {
            flex: 1;
            font-size: 12px;
            color: #88c0d0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .equip-slot-clear {
            padding: 2px 6px;
            font-size: 11px;
            background: #333;
            color: #aaa;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .equip-slot-clear:hover {
            background: #f44336;
            color: #fff;
        }
        /* Status table */
        .status-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        .status-table th {
            color: #f0c040;
            font-size: 12px;
            padding: 6px 8px;
            text-align: right;
            border-bottom: 2px solid #444;
        }
        .status-table th:first-child {
            text-align: left;
        }
        .status-table td {
            padding: 5px 8px;
            text-align: right;
            border-bottom: 1px solid #333;
            font-size: 13px;
        }
        .status-table td:first-child {
            text-align: left;
            color: #aaa;
        }
        .status-table .base-val { color: #4fc3f7; }
        .status-table .equip-val { color: #88c0d0; }
        .status-table .total-val { color: #f0c040; font-weight: bold; }
        .combat-stats-section {
            margin-top: 10px;
        }
        .combat-stats-section h3 {
            margin: 10px 0 8px 0;
        }
        @media (max-width: 600px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>FF11 Status Simulator</h1>

    <div class="tabs">
        <button class="tab-btn active" data-tab="tab-characters">Character Management</button>
        <button class="tab-btn" data-tab="tab-equipsets">Equipment Set</button>
        <button class="tab-btn" data-tab="tab-calc">Status Calculation</button>
    </div>

    <!-- Tab 1: Character Management -->
    <div id="tab-characters" class="tab-content active">
        <div class="container">
            <div>
                <h2>Registered Characters</h2>
                <ul class="char-list" id="charList">
                    <li class="empty-msg">No characters registered</li>
                </ul>
                <div class="btn-group">
                    <button class="btn btn-primary" id="btnNewChar">New Character</button>
                </div>
            </div>

            <div id="charEditSection" class="hidden">
                <h2 id="charEditTitle">New Character</h2>
                <div class="form-group">
                    <label for="charName">Name</label>
                    <input type="text" id="charName" placeholder="Character name">
                </div>
                <div class="form-group">
                    <label for="charRace">Race</label>
                    <select id="charRace">
                        <option value="Hum">Hume</option>
                        <option value="Elv">Elvaan</option>
                        <option value="Tar">Tarutaru</option>
                        <option value="Mit">Mithra</option>
                        <option value="Gal">Galka</option>
                    </select>
                </div>

                <h3>Job Levels</h3>
                <table class="job-level-table">
                    <thead>
                        <tr>
                            <th>Job</th>
                            <th>Lv</th>
                            <th>MLv</th>
                        </tr>
                    </thead>
                    <tbody id="jobLevelTable"></tbody>
                </table>

                <div class="merit-section">
                    <h3>Merit Points (0-15)</h3>
                    <div class="merit-grid">
                        <div class="merit-item">
                            <label for="charMeritHp">HP</label>
                            <input type="number" id="charMeritHp" min="0" max="15" value="15">
                        </div>
                        <div class="merit-item">
                            <label for="charMeritMp">MP</label>
                            <input type="number" id="charMeritMp" min="0" max="15" value="15">
                        </div>
                        <div class="merit-item">
                            <label for="charMeritStr">STR</label>
                            <input type="number" id="charMeritStr" min="0" max="15" value="15">
                        </div>
                        <div class="merit-item">
                            <label for="charMeritDex">DEX</label>
                            <input type="number" id="charMeritDex" min="0" max="15" value="15">
                        </div>
                        <div class="merit-item">
                            <label for="charMeritVit">VIT</label>
                            <input type="number" id="charMeritVit" min="0" max="15" value="15">
                        </div>
                        <div class="merit-item">
                            <label for="charMeritAgi">AGI</label>
                            <input type="number" id="charMeritAgi" min="0" max="15" value="15">
                        </div>
                        <div class="merit-item">
                            <label for="charMeritInt">INT</label>
                            <input type="number" id="charMeritInt" min="0" max="15" value="15">
                        </div>
                        <div class="merit-item">
                            <label for="charMeritMnd">MND</label>
                            <input type="number" id="charMeritMnd" min="0" max="15" value="15">
                        </div>
                        <div class="merit-item">
                            <label for="charMeritChr">CHR</label>
                            <input type="number" id="charMeritChr" min="0" max="15" value="15">
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" id="btnSaveChar">Save</button>
                    <button class="btn btn-danger" id="btnCancelEdit">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 2: Equipment Set -->
    <div id="tab-equipsets" class="tab-content">
        <div class="container">
            <div>
                <h2>Equipment Sets</h2>
                <ul class="char-list" id="equipSetList">
                    <li class="empty-msg">No equipment sets registered</li>
                </ul>
                <div class="btn-group">
                    <button class="btn btn-primary" id="btnNewEquipSet">New Equipment Set</button>
                </div>
            </div>

            <div id="equipEditSection" class="hidden">
                <h2 id="equipEditTitle">New Equipment Set</h2>
                <div class="form-group">
                    <label for="equipSetJob">Main Job</label>
                    <select id="equipSetJob">
                        <option value="">-- Select Job --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="equipSetName">Name</label>
                    <input type="text" id="equipSetName" placeholder="Equipment set name">
                </div>

                <div id="equipSlotsContainer"></div>

                <div class="btn-group">
                    <button class="btn btn-primary" id="btnSaveEquipSet">Save</button>
                    <button class="btn btn-danger" id="btnCancelEquipEdit">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 3: Status Calculation (from profile) -->
    <div id="tab-calc" class="tab-content">
        <div class="container">
            <div class="input-section">
                <h2>Calculation Settings</h2>

                <div class="form-group">
                    <label for="calcChar">Character</label>
                    <select id="calcChar">
                        <option value="">-- Select Character --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="calcMainJob">Main Job</label>
                    <select id="calcMainJob">
                        <option value="">-- Select Main Job --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="calcSupportJob">Support Job</label>
                    <select id="calcSupportJob">
                        <option value="">None</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="calcEquipSet">Equipment Set</label>
                    <select id="calcEquipSet">
                        <option value="">None</option>
                    </select>
                </div>

                <div id="calcInfo" class="support-section hidden">
                    <p style="margin:0;color:#aaa;font-size:13px;" id="calcInfoText"></p>
                </div>
            </div>

            <div class="result-section">
                <h2>Status</h2>
                <table class="status-table">
                    <thead>
                        <tr>
                            <th>Stat</th>
                            <th>Base</th>
                            <th>Equip</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="statusTableBody">
                        <tr><td>HP</td><td class="base-val" id="calcBaseHp">-</td><td class="equip-val" id="calcEquipHp">-</td><td class="total-val" id="calcTotalHp">-</td></tr>
                        <tr><td>MP</td><td class="base-val" id="calcBaseMp">-</td><td class="equip-val" id="calcEquipMp">-</td><td class="total-val" id="calcTotalMp">-</td></tr>
                        <tr><td>STR</td><td class="base-val" id="calcBaseStr">-</td><td class="equip-val" id="calcEquipStr">-</td><td class="total-val" id="calcTotalStr">-</td></tr>
                        <tr><td>DEX</td><td class="base-val" id="calcBaseDex">-</td><td class="equip-val" id="calcEquipDex">-</td><td class="total-val" id="calcTotalDex">-</td></tr>
                        <tr><td>VIT</td><td class="base-val" id="calcBaseVit">-</td><td class="equip-val" id="calcEquipVit">-</td><td class="total-val" id="calcTotalVit">-</td></tr>
                        <tr><td>AGI</td><td class="base-val" id="calcBaseAgi">-</td><td class="equip-val" id="calcEquipAgi">-</td><td class="total-val" id="calcTotalAgi">-</td></tr>
                        <tr><td>INT</td><td class="base-val" id="calcBaseInt">-</td><td class="equip-val" id="calcEquipInt">-</td><td class="total-val" id="calcTotalInt">-</td></tr>
                        <tr><td>MND</td><td class="base-val" id="calcBaseMnd">-</td><td class="equip-val" id="calcEquipMnd">-</td><td class="total-val" id="calcTotalMnd">-</td></tr>
                        <tr><td>CHR</td><td class="base-val" id="calcBaseChr">-</td><td class="equip-val" id="calcEquipChr">-</td><td class="total-val" id="calcTotalChr">-</td></tr>
                    </tbody>
                </table>

                <div class="combat-stats-section">
                    <h3>Combat Stats (Equipment)</h3>
                    <table class="status-table">
                        <thead>
                            <tr><th>Stat</th><th>Value</th></tr>
                        </thead>
                        <tbody id="combatStatsBody">
                            <tr><td>DEF</td><td class="equip-val" id="calcCombatDef">-</td></tr>
                            <tr><td>Attack</td><td class="equip-val" id="calcCombatAttack">-</td></tr>
                            <tr><td>Accuracy</td><td class="equip-val" id="calcCombatAccuracy">-</td></tr>
                            <tr><td>Evasion</td><td class="equip-val" id="calcCombatEvasion">-</td></tr>
                            <tr><td>R.Attack</td><td class="equip-val" id="calcCombatRangedAttack">-</td></tr>
                            <tr><td>R.Accuracy</td><td class="equip-val" id="calcCombatRangedAccuracy">-</td></tr>
                            <tr><td>M.Atk.Bonus</td><td class="equip-val" id="calcCombatMagicAttack">-</td></tr>
                            <tr><td>M.Accuracy</td><td class="equip-val" id="calcCombatMagicAccuracy">-</td></tr>
                            <tr><td>M.Evasion</td><td class="equip-val" id="calcCombatMagicEvasion">-</td></tr>
                            <tr><td>M.Damage</td><td class="equip-val" id="calcCombatMagicDamage">-</td></tr>
                            <tr><td>Haste</td><td class="equip-val" id="calcCombatHaste">-</td></tr>
                            <tr><td>Store TP</td><td class="equip-val" id="calcCombatStoreTp">-</td></tr>
                            <tr><td>Double Atk.</td><td class="equip-val" id="calcCombatDoubleAttack">-</td></tr>
                            <tr><td>Triple Atk.</td><td class="equip-val" id="calcCombatTripleAttack">-</td></tr>
                            <tr><td>Crit.Rate</td><td class="equip-val" id="calcCombatCritRate">-</td></tr>
                            <tr><td>WS Damage</td><td class="equip-val" id="calcCombatWsDamage">-</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="js/item-search.js"></script>
    <script src="js/equip-stats.js"></script>
    <script type="module">
        import init, { calculate_status_from_profile } from './pkg/ff11sim.js';

        let wasmReady = false;
        const itemSearch = new ItemSearch();
        let itemsLoaded = false;

        const JOBS = [
            { key: 'War', name: 'Warrior' },
            { key: 'Mnk', name: 'Monk' },
            { key: 'Whm', name: 'White Mage' },
            { key: 'Blm', name: 'Black Mage' },
            { key: 'Rdm', name: 'Red Mage' },
            { key: 'Thf', name: 'Thief' },
            { key: 'Pld', name: 'Paladin' },
            { key: 'Drk', name: 'Dark Knight' },
            { key: 'Bst', name: 'Beastmaster' },
            { key: 'Brd', name: 'Bard' },
            { key: 'Rng', name: 'Ranger' },
            { key: 'Sam', name: 'Samurai' },
            { key: 'Nin', name: 'Ninja' },
            { key: 'Drg', name: 'Dragoon' },
            { key: 'Smn', name: 'Summoner' },
            { key: 'Blu', name: 'Blue Mage' },
            { key: 'Cor', name: 'Corsair' },
            { key: 'Pup', name: 'Puppetmaster' },
            { key: 'Dnc', name: 'Dancer' },
            { key: 'Sch', name: 'Scholar' },
            { key: 'Geo', name: 'Geomancer' },
            { key: 'Run', name: 'Rune Fencer' },
        ];

        const RACE_NAMES = {
            'Hum': 'Hume', 'Elv': 'Elvaan', 'Tar': 'Tarutaru', 'Mit': 'Mithra', 'Gal': 'Galka'
        };

        const EQUIPMENT_SLOTS = [
            { key: 'main',  label: 'Main' },
            { key: 'sub',   label: 'Sub' },
            { key: 'range', label: 'Range' },
            { key: 'ammo',  label: 'Ammo' },
            { key: 'head',  label: 'Head' },
            { key: 'body',  label: 'Body' },
            { key: 'hands', label: 'Hands' },
            { key: 'legs',  label: 'Legs' },
            { key: 'feet',  label: 'Feet' },
            { key: 'neck',  label: 'Neck' },
            { key: 'waist', label: 'Waist' },
            { key: 'ear1',  label: 'Ear 1' },
            { key: 'ear2',  label: 'Ear 2' },
            { key: 'ring1', label: 'Ring 1' },
            { key: 'ring2', label: 'Ring 2' },
            { key: 'back',  label: 'Back' },
        ];

        // --- localStorage helpers ---
        const STORAGE_KEY = 'ff11sim_characters';
        const EQUIP_STORAGE_KEY = 'ff11sim_equipsets';

        function loadCharacters() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch {
                return [];
            }
        }

        function saveCharacters(characters) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(characters));
        }

        function loadEquipSets() {
            try {
                const data = localStorage.getItem(EQUIP_STORAGE_KEY);
                const sets = data ? JSON.parse(data) : [];
                // Ensure backward compatibility: add job field if missing
                return sets.map(s => ({ job: '', ...s }));
            } catch {
                return [];
            }
        }

        function saveEquipSets(sets) {
            localStorage.setItem(EQUIP_STORAGE_KEY, JSON.stringify(sets));
        }

        // --- Tab switching ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // ==============================================
        // Tab 1: Character Management
        // ==============================================

        let editingCharName = null;

        function buildJobLevelTable() {
            const tbody = document.getElementById('jobLevelTable');
            tbody.innerHTML = '';
            JOBS.forEach(job => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="job-name">${job.key}</td>
                    <td><input type="number" id="jl_${job.key}_lv" min="0" max="99" value="99"></td>
                    <td><input type="number" id="jl_${job.key}_mlv" min="0" max="50" value="0"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderCharList() {
            const characters = loadCharacters();
            const list = document.getElementById('charList');
            if (characters.length === 0) {
                list.innerHTML = '<li class="empty-msg">No characters registered</li>';
            } else {
                list.innerHTML = '';
                characters.forEach(ch => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>
                            <span class="char-info">${ch.name}</span>
                            <span class="char-race">${RACE_NAMES[ch.race] || ch.race}</span>
                        </span>
                        <span class="char-actions">
                            <button class="btn btn-primary btn-sm" data-edit="${ch.name}">Edit</button>
                            <button class="btn btn-danger btn-sm" data-delete="${ch.name}">Delete</button>
                        </span>
                    `;
                    list.appendChild(li);
                });
            }
            updateCalcCharSelector();
        }

        function showEditForm(character) {
            const section = document.getElementById('charEditSection');
            section.classList.remove('hidden');

            if (character) {
                editingCharName = character.name;
                document.getElementById('charEditTitle').textContent = 'Edit Character';
                document.getElementById('charName').value = character.name;
                document.getElementById('charRace').value = character.race;
                JOBS.forEach(job => {
                    const jl = character.job_levels[job.key] || { level: 0, master_lv: 0 };
                    document.getElementById(`jl_${job.key}_lv`).value = jl.level;
                    document.getElementById(`jl_${job.key}_mlv`).value = jl.master_lv;
                });
                const mp = character.merit_points || {};
                document.getElementById('charMeritHp').value = mp.hp || 0;
                document.getElementById('charMeritMp').value = mp.mp || 0;
                document.getElementById('charMeritStr').value = mp.str_ || 0;
                document.getElementById('charMeritDex').value = mp.dex || 0;
                document.getElementById('charMeritVit').value = mp.vit || 0;
                document.getElementById('charMeritAgi').value = mp.agi || 0;
                document.getElementById('charMeritInt').value = mp.int || 0;
                document.getElementById('charMeritMnd').value = mp.mnd || 0;
                document.getElementById('charMeritChr').value = mp.chr || 0;
            } else {
                editingCharName = null;
                document.getElementById('charEditTitle').textContent = 'New Character';
                document.getElementById('charName').value = '';
                document.getElementById('charRace').value = 'Hum';
                JOBS.forEach(job => {
                    document.getElementById(`jl_${job.key}_lv`).value = 99;
                    document.getElementById(`jl_${job.key}_mlv`).value = 0;
                });
                ['Hp','Mp','Str','Dex','Vit','Agi','Int','Mnd','Chr'].forEach(s => {
                    document.getElementById(`charMerit${s}`).value = 15;
                });
            }
        }

        function hideEditForm() {
            document.getElementById('charEditSection').classList.add('hidden');
            editingCharName = null;
        }

        function saveCharacter() {
            const name = document.getElementById('charName').value.trim();
            if (!name) {
                alert('Please enter a character name.');
                return;
            }

            const race = document.getElementById('charRace').value;
            const job_levels = {};
            JOBS.forEach(job => {
                const lv = parseInt(document.getElementById(`jl_${job.key}_lv`).value) || 0;
                const mlv = parseInt(document.getElementById(`jl_${job.key}_mlv`).value) || 0;
                job_levels[job.key] = { level: lv, master_lv: mlv };
            });

            const merit_points = {
                hp: parseInt(document.getElementById('charMeritHp').value) || 0,
                mp: parseInt(document.getElementById('charMeritMp').value) || 0,
                str_: parseInt(document.getElementById('charMeritStr').value) || 0,
                dex: parseInt(document.getElementById('charMeritDex').value) || 0,
                vit: parseInt(document.getElementById('charMeritVit').value) || 0,
                agi: parseInt(document.getElementById('charMeritAgi').value) || 0,
                int: parseInt(document.getElementById('charMeritInt').value) || 0,
                mnd: parseInt(document.getElementById('charMeritMnd').value) || 0,
                chr: parseInt(document.getElementById('charMeritChr').value) || 0,
            };

            const characters = loadCharacters();

            if (editingCharName) {
                const idx = characters.findIndex(c => c.name === editingCharName);
                if (idx >= 0) {
                    characters[idx] = { name, race, job_levels, merit_points };
                }
            } else {
                if (characters.some(c => c.name === name)) {
                    alert(`Character "${name}" already exists.`);
                    return;
                }
                characters.push({ name, race, job_levels, merit_points });
            }

            saveCharacters(characters);
            renderCharList();
            hideEditForm();
        }

        function deleteCharacter(name) {
            if (!confirm(`Delete character "${name}"?`)) return;
            const characters = loadCharacters().filter(c => c.name !== name);
            saveCharacters(characters);
            renderCharList();
            if (editingCharName === name) hideEditForm();
        }

        document.getElementById('charList').addEventListener('click', (e) => {
            const editBtn = e.target.closest('[data-edit]');
            const deleteBtn = e.target.closest('[data-delete]');
            if (editBtn) {
                const name = editBtn.dataset.edit;
                const characters = loadCharacters();
                const ch = characters.find(c => c.name === name);
                if (ch) showEditForm(ch);
            }
            if (deleteBtn) {
                deleteCharacter(deleteBtn.dataset.delete);
            }
        });

        document.getElementById('btnNewChar').addEventListener('click', () => showEditForm(null));
        document.getElementById('btnSaveChar').addEventListener('click', saveCharacter);
        document.getElementById('btnCancelEdit').addEventListener('click', hideEditForm);

        // ==============================================
        // Tab 2: Equipment Set Management
        // ==============================================

        let editingEquipSetName = null;
        let currentEquipJob = ''; // Current job key for equip set being edited
        let currentEquipSlots = {}; // { slotKey: { item_id, name_en, name_ja } | null }

        function createEmptySlots() {
            const slots = {};
            EQUIPMENT_SLOTS.forEach(s => { slots[s.key] = null; });
            return slots;
        }

        function buildEquipSlotsUI() {
            const container = document.getElementById('equipSlotsContainer');
            container.innerHTML = '';
            EQUIPMENT_SLOTS.forEach(slot => {
                const row = document.createElement('div');
                row.className = 'equip-slot-row';

                const label = document.createElement('span');
                label.className = 'equip-slot-label';
                label.textContent = slot.label;

                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'equip-slot-input-wrapper';

                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'equip-slot-search';
                input.dataset.slot = slot.key;
                input.placeholder = 'Search...';

                const dropdown = document.createElement('div');
                dropdown.className = 'equip-slot-dropdown hidden';
                dropdown.dataset.slot = slot.key;

                inputWrapper.appendChild(input);
                inputWrapper.appendChild(dropdown);

                const selected = document.createElement('span');
                selected.className = 'equip-slot-selected';
                selected.dataset.slot = slot.key;
                selected.textContent = 'None';

                const clearBtn = document.createElement('button');
                clearBtn.className = 'equip-slot-clear';
                clearBtn.dataset.slot = slot.key;
                clearBtn.textContent = '\u00d7';

                row.appendChild(label);
                row.appendChild(inputWrapper);
                row.appendChild(selected);
                row.appendChild(clearBtn);
                container.appendChild(row);

                // Setup inline search
                setupSlotSearch(slot.key, input, dropdown);

                // Clear button
                clearBtn.addEventListener('click', () => {
                    currentEquipSlots[slot.key] = null;
                    selected.textContent = 'None';
                    input.value = '';
                });
            });
        }

        function setupSlotSearch(slotKey, input, dropdown) {
            let debounceTimer = null;

            input.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = input.value.trim();
                    if (query.length < 2 || !itemsLoaded) {
                        dropdown.classList.add('hidden');
                        return;
                    }
                    const results = itemSearch.search({
                        query: query,
                        slot: slotKey,
                        job: currentEquipJob ? currentEquipJob.toUpperCase() : '',
                        limit: 20,
                    });
                    renderSlotDropdown(dropdown, results.items, slotKey, input);
                }, 200);
            });

            input.addEventListener('blur', () => {
                setTimeout(() => dropdown.classList.add('hidden'), 200);
            });

            input.addEventListener('focus', () => {
                if (input.value.trim().length >= 2 && dropdown.children.length > 0) {
                    dropdown.classList.remove('hidden');
                }
            });
        }

        function renderSlotDropdown(dropdown, items, slotKey, input) {
            dropdown.innerHTML = '';
            if (items.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'equip-slot-dropdown-item';
                div.textContent = `${item.ja || item.en} (${item.en})`;
                div.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    selectSlotItem(slotKey, item);
                    dropdown.classList.add('hidden');
                    input.value = '';
                });
                dropdown.appendChild(div);
            });
            dropdown.classList.remove('hidden');
        }

        function selectSlotItem(slotKey, item) {
            currentEquipSlots[slotKey] = {
                item_id: item.id,
                name_en: item.en,
                name_ja: item.ja,
            };
            const selectedSpan = document.querySelector(`.equip-slot-selected[data-slot="${slotKey}"]`);
            if (selectedSpan) {
                selectedSpan.textContent = item.ja || item.en;
            }
        }

        function renderEquipSetList() {
            const sets = loadEquipSets();
            const list = document.getElementById('equipSetList');
            if (sets.length === 0) {
                list.innerHTML = '<li class="empty-msg">No equipment sets registered</li>';
            } else {
                list.innerHTML = '';
                // Group by job
                const grouped = {};
                sets.forEach(es => {
                    const jobKey = es.job || '';
                    if (!grouped[jobKey]) grouped[jobKey] = [];
                    grouped[jobKey].push(es);
                });
                // Render in job order, uncategorized last
                const jobOrder = JOBS.map(j => j.key).filter(k => grouped[k]);
                if (grouped['']) jobOrder.push('');

                jobOrder.forEach(jobKey => {
                    const jobName = jobKey ? JOBS.find(j => j.key === jobKey)?.name || jobKey : 'Uncategorized';
                    const header = document.createElement('li');
                    header.className = 'equip-group-header';
                    header.textContent = jobName;
                    list.appendChild(header);

                    grouped[jobKey].forEach(es => {
                        const li = document.createElement('li');
                        const count = Object.values(es.slots).filter(v => v !== null).length;
                        li.innerHTML = `
                            <span>
                                <span class="char-info">${es.name}</span>
                                <span class="char-race">${count} items</span>
                            </span>
                            <span class="char-actions">
                                <button class="btn btn-primary btn-sm" data-equip-edit="${es.name}">Edit</button>
                                <button class="btn btn-danger btn-sm" data-equip-delete="${es.name}">Delete</button>
                            </span>
                        `;
                        list.appendChild(li);
                    });
                });
            }
            updateCalcEquipSetSelector();
        }

        function showEquipSetEditForm(equipSet) {
            const section = document.getElementById('equipEditSection');
            section.classList.remove('hidden');

            if (equipSet) {
                editingEquipSetName = equipSet.name;
                currentEquipJob = equipSet.job || '';
                document.getElementById('equipEditTitle').textContent = 'Edit Equipment Set';
                document.getElementById('equipSetJob').value = currentEquipJob;
                document.getElementById('equipSetName').value = equipSet.name;
                currentEquipSlots = { ...equipSet.slots };
                // Update display for each slot
                EQUIPMENT_SLOTS.forEach(slot => {
                    const data = currentEquipSlots[slot.key];
                    const selectedSpan = document.querySelector(`.equip-slot-selected[data-slot="${slot.key}"]`);
                    if (selectedSpan) {
                        selectedSpan.textContent = data ? (data.name_ja || data.name_en) : 'None';
                    }
                });
            } else {
                editingEquipSetName = null;
                currentEquipJob = '';
                document.getElementById('equipEditTitle').textContent = 'New Equipment Set';
                document.getElementById('equipSetJob').value = '';
                document.getElementById('equipSetName').value = '';
                currentEquipSlots = createEmptySlots();
                EQUIPMENT_SLOTS.forEach(slot => {
                    const selectedSpan = document.querySelector(`.equip-slot-selected[data-slot="${slot.key}"]`);
                    if (selectedSpan) selectedSpan.textContent = 'None';
                    const input = document.querySelector(`.equip-slot-search[data-slot="${slot.key}"]`);
                    if (input) input.value = '';
                });
            }
        }

        function hideEquipSetEditForm() {
            document.getElementById('equipEditSection').classList.add('hidden');
            editingEquipSetName = null;
        }

        function saveEquipSet() {
            const name = document.getElementById('equipSetName').value.trim();
            if (!name) {
                alert('Please enter an equipment set name.');
                return;
            }

            const job = document.getElementById('equipSetJob').value;
            const sets = loadEquipSets();

            if (editingEquipSetName) {
                const idx = sets.findIndex(s => s.name === editingEquipSetName);
                if (idx >= 0) {
                    sets[idx] = { name, job, slots: { ...currentEquipSlots } };
                }
            } else {
                if (sets.some(s => s.name === name)) {
                    alert(`Equipment set "${name}" already exists.`);
                    return;
                }
                sets.push({ name, job, slots: { ...currentEquipSlots } });
            }

            saveEquipSets(sets);
            renderEquipSetList();
            hideEquipSetEditForm();
        }

        function deleteEquipSet(name) {
            if (!confirm(`Delete equipment set "${name}"?`)) return;
            const sets = loadEquipSets().filter(s => s.name !== name);
            saveEquipSets(sets);
            renderEquipSetList();
            if (editingEquipSetName === name) hideEquipSetEditForm();
        }

        document.getElementById('equipSetList').addEventListener('click', (e) => {
            const editBtn = e.target.closest('[data-equip-edit]');
            const deleteBtn = e.target.closest('[data-equip-delete]');
            if (editBtn) {
                const name = editBtn.dataset.equipEdit;
                const sets = loadEquipSets();
                const es = sets.find(s => s.name === name);
                if (es) showEquipSetEditForm(es);
            }
            if (deleteBtn) {
                deleteEquipSet(deleteBtn.dataset.equipDelete);
            }
        });

        document.getElementById('btnNewEquipSet').addEventListener('click', () => showEquipSetEditForm(null));
        document.getElementById('btnSaveEquipSet').addEventListener('click', saveEquipSet);
        document.getElementById('btnCancelEquipEdit').addEventListener('click', hideEquipSetEditForm);
        document.getElementById('equipSetJob').addEventListener('change', (e) => {
            currentEquipJob = e.target.value;
        });

        // ==============================================
        // Tab 3: Status Calculation from Profile
        // ==============================================

        function updateCalcCharSelector() {
            const sel = document.getElementById('calcChar');
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">-- Select Character --</option>';
            loadCharacters().forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch.name;
                opt.textContent = `${ch.name} (${RACE_NAMES[ch.race] || ch.race})`;
                sel.appendChild(opt);
            });
            if (currentVal && [...sel.options].some(o => o.value === currentVal)) {
                sel.value = currentVal;
            }
        }

        function updateCalcEquipSetSelector() {
            const sel = document.getElementById('calcEquipSet');
            const currentVal = sel.value;
            const mainJobKey = document.getElementById('calcMainJob').value;
            sel.innerHTML = '<option value="">None</option>';

            const sets = loadEquipSets();
            // Group by job
            const grouped = {};
            sets.forEach(es => {
                const jobKey = es.job || '';
                if (!grouped[jobKey]) grouped[jobKey] = [];
                grouped[jobKey].push(es);
            });

            // If main job is selected, show matching sets first, then others
            const jobOrder = JOBS.map(j => j.key).filter(k => grouped[k]);
            if (grouped['']) jobOrder.push('');

            // Prioritize: show matching job's sets at top level, others in optgroups
            if (mainJobKey && grouped[mainJobKey]) {
                grouped[mainJobKey].forEach(es => {
                    const opt = document.createElement('option');
                    opt.value = es.name;
                    opt.textContent = es.name;
                    sel.appendChild(opt);
                });
                // Add other jobs in optgroups
                jobOrder.filter(k => k !== mainJobKey).forEach(jobKey => {
                    const jobName = jobKey ? JOBS.find(j => j.key === jobKey)?.name || jobKey : 'Uncategorized';
                    const group = document.createElement('optgroup');
                    group.label = jobName;
                    grouped[jobKey].forEach(es => {
                        const opt = document.createElement('option');
                        opt.value = es.name;
                        opt.textContent = es.name;
                        group.appendChild(opt);
                    });
                    sel.appendChild(group);
                });
            } else {
                // No main job selected: show all in optgroups
                jobOrder.forEach(jobKey => {
                    const jobName = jobKey ? JOBS.find(j => j.key === jobKey)?.name || jobKey : 'Uncategorized';
                    const group = document.createElement('optgroup');
                    group.label = jobName;
                    grouped[jobKey].forEach(es => {
                        const opt = document.createElement('option');
                        opt.value = es.name;
                        opt.textContent = es.name;
                        group.appendChild(opt);
                    });
                    sel.appendChild(group);
                });
            }

            if (currentVal && [...sel.options].some(o => o.value === currentVal)) {
                sel.value = currentVal;
            }
        }

        function updateCalcJobSelectors() {
            const charName = document.getElementById('calcChar').value;
            const mainSel = document.getElementById('calcMainJob');
            const supSel = document.getElementById('calcSupportJob');

            mainSel.innerHTML = '<option value="">-- Select Main Job --</option>';
            supSel.innerHTML = '<option value="">None</option>';

            if (!charName) return;

            const characters = loadCharacters();
            const ch = characters.find(c => c.name === charName);
            if (!ch) return;

            JOBS.forEach(job => {
                const jl = ch.job_levels[job.key];
                if (jl && jl.level > 0) {
                    const mainOpt = document.createElement('option');
                    mainOpt.value = job.key;
                    mainOpt.textContent = `${job.name} (Lv${jl.level}/MLv${jl.master_lv})`;
                    mainSel.appendChild(mainOpt);

                    const supOpt = document.createElement('option');
                    supOpt.value = job.key;
                    supOpt.textContent = `${job.name} (Lv${jl.level})`;
                    supSel.appendChild(supOpt);
                }
            });
        }

        function calculateEquipSetBonuses(equipSetName) {
            if (!equipSetName || !itemsLoaded) return getEmptyStats();

            const sets = loadEquipSets();
            const set = sets.find(s => s.name === equipSetName);
            if (!set) return getEmptyStats();

            const statsArray = [];
            for (const slotKey of Object.keys(set.slots)) {
                const slotData = set.slots[slotKey];
                if (!slotData) continue;

                const item = itemSearch.items.find(i => i.id === slotData.item_id);
                if (!item || !item.description_en) continue;

                statsArray.push(extractAllStats(item.description_en));
            }

            return sumStats(statsArray);
        }

        function formatBonus(value) {
            if (!value || value === 0) return '-';
            return value > 0 ? `+${value}` : `${value}`;
        }

        function formatPctBonus(value) {
            if (!value || value === 0) return '-';
            return value > 0 ? `+${value}%` : `${value}%`;
        }

        const BASE_STATS = [
            { key: 'Hp', resultKey: 'hp', equipKey: 'hp', pctKey: 'hp_pct' },
            { key: 'Mp', resultKey: 'mp', equipKey: 'mp', pctKey: 'mp_pct' },
            { key: 'Str', resultKey: 'str_', equipKey: 'str' },
            { key: 'Dex', resultKey: 'dex', equipKey: 'dex' },
            { key: 'Vit', resultKey: 'vit', equipKey: 'vit' },
            { key: 'Agi', resultKey: 'agi', equipKey: 'agi' },
            { key: 'Int', resultKey: 'int', equipKey: 'int' },
            { key: 'Mnd', resultKey: 'mnd', equipKey: 'mnd' },
            { key: 'Chr', resultKey: 'chr', equipKey: 'chr' },
        ];

        const COMBAT_STATS = [
            { id: 'Def', key: 'def' },
            { id: 'Attack', key: 'attack', pctKey: 'attack_pct' },
            { id: 'Accuracy', key: 'accuracy' },
            { id: 'Evasion', key: 'evasion' },
            { id: 'RangedAttack', key: 'ranged_attack' },
            { id: 'RangedAccuracy', key: 'ranged_accuracy' },
            { id: 'MagicAttack', key: 'magic_attack' },
            { id: 'MagicAccuracy', key: 'magic_accuracy' },
            { id: 'MagicEvasion', key: 'magic_evasion' },
            { id: 'MagicDamage', key: 'magic_damage' },
            { id: 'Haste', key: 'haste_pct', isPct: true },
            { id: 'StoreTp', key: 'store_tp' },
            { id: 'DoubleAttack', key: 'double_attack_pct', isPct: true },
            { id: 'TripleAttack', key: 'triple_attack_pct', isPct: true },
            { id: 'CritRate', key: 'critical_hit_rate_pct', isPct: true },
            { id: 'WsDamage', key: 'weapon_skill_damage_pct', isPct: true },
        ];

        function clearAllStats() {
            BASE_STATS.forEach(s => {
                document.getElementById(`calcBase${s.key}`).textContent = '-';
                document.getElementById(`calcEquip${s.key}`).textContent = '-';
                document.getElementById(`calcTotal${s.key}`).textContent = '-';
            });
            COMBAT_STATS.forEach(s => {
                document.getElementById(`calcCombat${s.id}`).textContent = '-';
            });
            document.getElementById('calcInfo').classList.add('hidden');
        }

        function updateCalcStatus() {
            if (!wasmReady) return;

            const charName = document.getElementById('calcChar').value;
            const mainJobKey = document.getElementById('calcMainJob').value;

            if (!charName || !mainJobKey) {
                clearAllStats();
                return;
            }

            const characters = loadCharacters();
            const ch = characters.find(c => c.name === charName);
            if (!ch) {
                clearAllStats();
                return;
            }

            const supJobKey = document.getElementById('calcSupportJob').value || null;
            const equipSetName = document.getElementById('calcEquipSet').value;

            const profile = {
                name: ch.name,
                race: ch.race,
                job_levels: ch.job_levels,
                merit_points: ch.merit_points,
            };

            try {
                const result = calculate_status_from_profile(profile, mainJobKey, supJobKey);
                const equip = calculateEquipSetBonuses(equipSetName);

                // Update base stats
                BASE_STATS.forEach(s => {
                    const baseVal = result[s.resultKey];
                    const equipFlat = equip[s.equipKey] || 0;
                    const equipPct = s.pctKey ? (equip[s.pctKey] || 0) : 0;

                    let total = baseVal + equipFlat;
                    if (equipPct !== 0) {
                        total += Math.floor(baseVal * equipPct / 100);
                    }

                    document.getElementById(`calcBase${s.key}`).textContent = baseVal;

                    let equipDisplay = '';
                    if (equipFlat !== 0) equipDisplay = formatBonus(equipFlat);
                    if (equipPct !== 0) {
                        equipDisplay += (equipDisplay ? ' ' : '') + formatPctBonus(equipPct);
                    }
                    document.getElementById(`calcEquip${s.key}`).textContent = equipDisplay || '-';
                    document.getElementById(`calcTotal${s.key}`).textContent = total;
                });

                // Update combat stats
                COMBAT_STATS.forEach(s => {
                    const val = equip[s.key] || 0;
                    let display = '-';
                    if (val !== 0) {
                        if (s.isPct) {
                            display = formatPctBonus(val);
                        } else if (s.pctKey) {
                            const pctVal = equip[s.pctKey] || 0;
                            display = formatBonus(val);
                            if (pctVal !== 0) display += ' ' + formatPctBonus(pctVal);
                        } else {
                            display = formatBonus(val);
                        }
                    } else if (s.pctKey) {
                        const pctVal = equip[s.pctKey] || 0;
                        if (pctVal !== 0) display = formatPctBonus(pctVal);
                    }
                    document.getElementById(`calcCombat${s.id}`).textContent = display;
                });

                // Show info
                const mainJl = ch.job_levels[mainJobKey] || { level: 0, master_lv: 0 };
                let infoText = `${RACE_NAMES[ch.race]} / ${mainJobKey} Lv${mainJl.level} MLv${mainJl.master_lv}`;
                if (supJobKey) {
                    const supJl = ch.job_levels[supJobKey] || { level: 0, master_lv: 0 };
                    const cap = Math.floor(mainJl.level / 2) + Math.floor(mainJl.master_lv / 5);
                    const effectiveLv = Math.min(supJl.level, cap);
                    infoText += ` / ${supJobKey} Lv${effectiveLv}`;
                }
                if (equipSetName) {
                    infoText += ` / ${equipSetName}`;
                }
                document.getElementById('calcInfoText').textContent = infoText;
                document.getElementById('calcInfo').classList.remove('hidden');
            } catch (e) {
                console.error('Error calculating status from profile:', e);
                clearAllStats();
            }
        }

        document.getElementById('calcChar').addEventListener('change', () => {
            updateCalcJobSelectors();
            updateCalcStatus();
        });
        document.getElementById('calcMainJob').addEventListener('change', () => {
            updateCalcEquipSetSelector();
            updateCalcStatus();
        });
        document.getElementById('calcSupportJob').addEventListener('change', updateCalcStatus);
        document.getElementById('calcEquipSet').addEventListener('change', updateCalcStatus);

        // ==============================================
        // Initialize
        // ==============================================
        async function initWasm() {
            await Promise.all([
                init(),
                itemSearch.load('./data/items.json').then(() => { itemsLoaded = true; }),
            ]);
            wasmReady = true;
            buildJobLevelTable();
            buildEquipSlotsUI();
            // Populate equipment set job selector
            const equipJobSel = document.getElementById('equipSetJob');
            JOBS.forEach(job => {
                const opt = document.createElement('option');
                opt.value = job.key;
                opt.textContent = job.name;
                equipJobSel.appendChild(opt);
            });
            renderCharList();
            renderEquipSetList();
        }

        initWasm();
    </script>
</body>
</html>
